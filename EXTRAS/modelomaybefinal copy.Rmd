---
title: "Modelo 2"
output:
  html_document:
    df_print: paged
---

Preparo la conexión con postgres

```{r}
#install.packages("RPostgreSQL")
require("RPostgreSQL")

# Guardar el Password para poder posteriormente eliminarlo
pw <- { "1796vd"}

# Leer el driver de PostgreSQL
drv <- dbDriver("PostgreSQL")

# Crear la conexion con la base de datos
con <- dbConnect(drv, dbname = "postgres",
                 host = "localhost", port = 5432,
                 user = "postgres", password = pw)
# Eliminar el Password
rm(pw) 

# Chequear que existe la tabla de la base de datos para comprobar la conexión
dbExistsTable(con, "descripcion_carnet")

```


Importo los paquetes más genéricos

```{r}
library(readr)
library(ISLR)
library(ggplot2)
library(caret)
library(dplyr)
library(magrittr)
library(tidyverse)
library(rpart)
library(rpart.plot)
```



Importo la data de clima 
```{r}
clima <-dbGetQuery(con, "SELECT * FROM descripcion_fecha_accidente_y_su_clima")
head(clima)
```


Importo la tabla accidente que es la que se relaciona con la fecha 

```{r}
acc <-dbGetQuery(con, "SELECT * FROM accidente")
head(acc)
```


Combino las tablas 

```{r}
datos<-merge(x = clima, y = acc, by = "id_desc_fecha", all = TRUE)
head(datos)
```


```{r}
datos1<- datos[,c("id_desc_fecha", "desc_fecha", "id_accidente", "precipitaciones", "temperatura_media", "velocidad_viento_media", "id_desc_dia_semana", "hora")]
head(datos1)
```

Se toma parametro como día entre las 7 am y las 9pm 
```{r}
for(i in 1:nrow(datos1))
  {
  if (datos1$hora[i] <=7.0) { 
    datos1$horario[i]<-"noche"
} else if (datos1$hora[i] >21.0){
    datos1$horario[i]<-"noche"
} else {
 datos1$horario[i]<-"dia"
}
}

datos1
```

Ahora se agrupa por fecha y horario

```{r}
datos2<- datos1 %>%
  group_by(desc_fecha, horario, precipitaciones, temperatura_media, velocidad_viento_media, id_desc_dia_semana) %>%
  summarise(cant_accidentes=n())
datos2
```

Ahora se determina la estación del año

Invierno: 21 de diciembre al 20 de marzo
Primavera: 21 de marzo al 20 de junio 
Verano: 21 de junio al 20 de septiembre
Otoño: 21 de septiembre al 20 de diciembre

```{r}
library(hydroTSM)

for(i in 1:nrow(datos2))
  {datos2$estacion <- time2season(datos2$desc_fecha, out.fmt = "seasons")
}

datos2
```

```{r}
for(i in 1:nrow(datos2))
  {
  if (!is.na(datos2$precipitaciones[i])) {
    if (datos2$precipitaciones[i] ==0.0) { 
      datos2$precipitacion[i]<-"No llueve"
  } else if (datos2$precipitaciones[i] <=25.0){
      datos2$precipitacion[i]<-"Lluvia debil"
  } else if (datos2$precipitaciones[i] <=50.0){
      datos2$precipitacion[i]<-"Lluvia moderada"
  } else {
    datos2$precipitacion[i]<-"Lluvia fuerte"
  }}}
datos2
```

  Ahora se convierte en niveles y se eliminan las columnas ue no se van a usar.
  
```{r}
datos3<- datos2[,c("desc_fecha", "horario", "cant_accidentes", "id_desc_dia_semana", "estacion", "precipitacion", "temperatura_media", "velocidad_viento_media")]
head(datos3)
```
Para el horario
```{r}
unique(datos3$horario)
```

-0: dia
-1: noche

```{r}
datos3$horario<-ifelse(datos3$horario == "dia", 1, datos3$horario)
datos3$horario<-ifelse(datos3$horario == "noche", 0, datos3$horario)
```

```{r}
unique(datos3$horario)
```


En las estaciones:
-0: winter
-1: spring
-2: summer
-3: autumm

```{r}
unique(datos3$estacion)
```


```{r}
datos3$estacion<-ifelse(datos3$estacion == "winter", 0, datos3$estacion)
datos3$estacion<-ifelse(datos3$estacion == "spring", 1, datos3$estacion)
datos3$estacion<-ifelse(datos3$estacion == "summer", 2, datos3$estacion)
datos3$estacion<-ifelse(datos3$estacion == "autumm", 3, datos3$estacion)
```

Se comprueba

```{r}
unique(datos3$estacion)
```

Ahora se siguen los pasos anteriores con la precipitacion


```{r}
unique(datos3$precipitacion)
```

En el caso de la lluvia:
-0: No llueve
-1: Lluvia debil 
-2: LLuvia moderada
-3: Lluvia fuerte


```{r}
datos3$precipitacion<-ifelse(datos3$precipitacion == "No llueve", 0, datos3$precipitacion)
datos3$precipitacion<-ifelse(datos3$precipitacion == "Lluvia debil", 1, datos3$precipitacion)
datos3$precipitacion<-ifelse(datos3$precipitacion == "Lluvia moderada", 2, datos3$precipitacion)
datos3$precipitacion<-ifelse(datos3$precipitacion == "Lluvia fuerte", 3, datos3$precipitacion)
```

Se comprueba

```{r}
unique(datos3$precipitacion)
```

Para ver el día de la semana, se importa la tabla desde la base de datos

```{r}
dia_sem <-dbGetQuery(con, "SELECT * FROM descripcion_dia_semana_accidente")
dia_sem
```

Como se puede observar no está en orden, por lo que se procede a ordenar en la tabla. 

1: lunes
2: martes
3: miercoles
4: jueves
5: viernes
6: sabado 
7: domingo 

```{r}
datos3$id_desc_dia_semana<-ifelse(datos3$id_desc_dia_semana == 1, 2, datos3$id_desc_dia_semana)
datos3$id_desc_dia_semana<-ifelse(datos3$id_desc_dia_semana == 2, 6, datos3$id_desc_dia_semana)
datos3$id_desc_dia_semana<-ifelse(datos3$id_desc_dia_semana == 3, 3, datos3$id_desc_dia_semana)
datos3$id_desc_dia_semana<-ifelse(datos3$id_desc_dia_semana == 4, 5, datos3$id_desc_dia_semana)
datos3$id_desc_dia_semana<-ifelse(datos3$id_desc_dia_semana == 5, 4, datos3$id_desc_dia_semana)
datos3$id_desc_dia_semana<-ifelse(datos3$id_desc_dia_semana == 6, 7, datos3$id_desc_dia_semana)
datos3$id_desc_dia_semana<-ifelse(datos3$id_desc_dia_semana == 7, 1, datos3$id_desc_dia_semana)
```




##Modelo lineal 

Transformar todas las variables en numericas

```{r}
str(datos3)
```


```{r}
datos3$horario<- as.numeric(datos3$horario)
datos3$estacion<-as.numeric(datos3$estacion)
datos3$precipitacion<-as.numeric(datos3$precipitacion)
datos3$velocidad_viento_media<-as.numeric(datos3$velocidad_viento_media)
datos3$cant_accidentes<-as.numeric(datos3$cant_accidentes)
```

Se comprueba

```{r}
str(datos3)
```

Revisamos los nombres de las variables 

```{r}
names(datos3)
```

Dividimos en data train y test 


```{r}
shuffle_index <- sample(1:nrow(datos3))
head(shuffle_index)
datos3 <- datos3[shuffle_index, ]
```

Limpio los datos para que no exista el NA


```{r}
clean_datos <- datos3 %>%
  select(c(cant_accidentes, id_desc_dia_semana, temperatura_media, horario, estacion, velocidad_viento_media, precipitacion)) %>% 
  na.omit()
glimpse(clean_datos)
head(clean_datos)
clean_datos
```


```{r}
set.seed(101) # Set Seed so that same sample can be reproduced in future also
# Now Selecting 75% of data as sample from total 'n' rows of the data  
sample <- sample.int(n = nrow(clean_datos), size = floor(.75*nrow(clean_datos)), replace = F)
train <- clean_datos[sample, ]
test  <- clean_datos[-sample, ]
```


Construimos el modelo

```{r}
modelo<- lm(data=train, formula= cant_accidentes ~ id_desc_dia_semana + temperatura_media + horario + estacion + velocidad_viento_media + precipitacion)
```

Visualizar los parámetros del modelo.

```{r}
summary(modelo)
```

En esta información se puede apreciar que el p valor es muy pequeño, lo que indica que hay al menos una variable que está relacionada con la variable que se busca predecir. Además el Rˆ2 = 67.73%

Para determinar la calidad del modelo se va a utilizar el método stepwise mixto. 

```{r}
step(modelo, direction="both", trace=1)
```

El call arroja la formula 
      lm(formula = cant_accidentes ~ id_desc_dia_semana + temperatura_media + horario + estacion + precipitacion, data =        datos3)
ya que se excluye la variable viento por tener el mayor p valor; es por esto que se actualiza la fórmula del modelo. 


```{r}
modelo1<-lm(cant_accidentes ~ id_desc_dia_semana + temperatura + 
    horario + estacion + precipitacion, data = datos3)
```

```{r}
summary(modelo1)
```

El p-valor, luego de eliminar la variable viento sigue siendo muy pequeño por lo que el modelo es correcto.

```{r}
pairs(cant_accidentes ~ id_desc_dia_semana + temperatura + 
    horario + estacion + precipitacion, data = datos3, main="Matriz de dispersión de la cantidad de accidentes por los factores climatológicos")
```

