---
title: "Accidentes - Random Forest"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Tabla accidentes 

Preparo la conección con R

```{r}

#install.packages("RPostgreSQL")
require("RPostgreSQL")

# Guardar el Password para poder posteriormente eliminarlo
pw <- { "1796vd"}

# Leer el driver de PostgreSQL
drv <- dbDriver("PostgreSQL")

# Crear la conexion con la base de datos
con <- dbConnect(drv, dbname = "postgres",
                 host = "localhost", port = 5432,
                 user = "postgres", password = pw)
# Eliminar el Password
rm(pw) 

# Chequear que existe la tabla de la base de datos para comprobar la conexión
dbExistsTable(con, "accidente")

```


Importo los paquetes más genéricos

```{r}
library(readr)
library(ISLR)
library(ggplot2)
library(caret)
library(dplyr)
library(magrittr)
library(tidyverse)
library(rpart)
library(rpart.plot)
library(hydroTSM)
library(randomForest)
```

Importo la data de la tabla de accidentes 

```{r}
accidente<- dbGetQuery(con, "SELECT * FROM accidente")
head(accidente)
```

Quiero agrupar por accidentes por distrito. Para ello:

Hago un join para conocer el nombre del distrito y la fecha: 

```{r}
datos <- dbGetQuery(con, 
                    "SELECT *
FROM accidente
INNER JOIN descripcion_distrito_accidente ON accidente.id_desc_distrito = descripcion_distrito_accidente.id_desc_distrito
INNER JOIN descripcion_fecha_accidente_y_su_clima ON accidente.id_desc_fecha=descripcion_fecha_accidente_y_su_clima.id_desc_fecha
INNER JOIN descripcion_tipologia_accidente ON accidente.id_desc_tipologia = descripcion_tipologia_accidente.id_desc_tipologia") 

head(datos)
```

Selecciono las columnas que voy a utilizar:

```{r}
datos1<- datos[,c("desc_distrito", "desc_fecha","id_desc_dia_semana", "hora", "desc_tipologia")]
head(datos1)
```

Para buscar los días de la semana: 

```{r}
dia_sem <-dbGetQuery(con, "SELECT * FROM descripcion_dia_semana_accidente")
dia_sem
```

Como se puede observar no están ordenados por lo que procedo a ordenarlos:

```{r}
datos1$id_desc_dia_semana<-ifelse(datos1$id_desc_dia_semana == 1, 7, datos1$id_desc_dia_semana)
datos1$id_desc_dia_semana<-ifelse(datos1$id_desc_dia_semana == 2, 1, datos1$id_desc_dia_semana)
datos1$id_desc_dia_semana<-ifelse(datos1$id_desc_dia_semana == 3, 3, datos1$id_desc_dia_semana)
datos1$id_desc_dia_semana<-ifelse(datos1$id_desc_dia_semana == 4, 5, datos1$id_desc_dia_semana)
datos1$id_desc_dia_semana<-ifelse(datos1$id_desc_dia_semana == 5, 4, datos1$id_desc_dia_semana)
datos1$id_desc_dia_semana<-ifelse(datos1$id_desc_dia_semana == 6, 2, datos1$id_desc_dia_semana)
datos1$id_desc_dia_semana<-ifelse(datos1$id_desc_dia_semana == 7, 6, datos1$id_desc_dia_semana)
```



También determino si es de madrugada, mañana, tarde o noche:

```{r}
for(i in 1:nrow(datos1))
  {
  if      (datos1$hora[i] < 7.0)  { datos1$horario[i]<-"madrugada"} 
  else if (datos1$hora[i] >= 19.0){ datos1$horario[i]<-"noche"}
  else if (datos1$hora[i] >= 13.0){ datos1$horario[i]<-"tarde"}
  else                            { datos1$horario[i]<-"mañana"}
  }

head(datos1)
```

Ahora agrupo: 

En este caso quiero determinar el peso que tienen las variables epoca del año, día de la semana, tipología y  si era de día, tarde, noche o madrugada sobre que un vehículo se vea involucrado en un accidente

```{r}
datos2<- datos1 %>%
  group_by(desc_distrito, desc_tipologia, horario, id_desc_dia_semana) %>%
  summarise(cant_tipologias_distrito=n())
datos2
```
"desc_distrito", "desc_fecha","id_desc_dia_semana", "hora", "desc_tipologia"
Lo que hice fue contar cuantos registros hay en cada distrito según la tipología, el horario y el día de la semana. 

Esto permite analizar el peso del día de la semana, la tipología, el distrito y el horario en la cantidad registrada. 

Convierto en factor las demás variables: 

```{r}
datos2$id_desc_dia_semana<-as.factor(datos2$id_desc_dia_semana)
datos2$desc_tipologia<-as.factor(datos2$desc_tipologia)
datos2$horario<-as.factor(datos2$horario)
```

Partimos el dataset en 2 grupos para trabajar entrenamiento y validación

```{r}
set.seed(12)

```

```{r}
smp_size <- floor(0.75 * nrow(datos2))

set.seed(123)
train_ind <- sample(seq_len(nrow(datos2)), size = smp_size)

train <- datos2[train_ind, ]
test <- datos2[-train_ind, ]
```

Ahora hago el modelo

```{r}
model.rf <- randomForest(formula = cant_tipologias_distrito ~ desc_tipologia + horario + id_desc_dia_semana, importance = TRUE ,data = train)
varImpPlot(model.rf)
```


```{r}
summary(model.rf)
```

```{r}
preds <- predict(model.rf,data = train)
real <- train$cant_tipologias_distrito
plot(real, preds)
```

```{r}
RMSE <- sqrt(mean((real - preds)^2))
RMSE
```

