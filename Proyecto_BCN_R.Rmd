---
title: "ACCIDENTES DE TRÁFICO EN BARCELONA"
output: html_notebook
---

*El objetivo de este trabajo es analizar a través de tablas y gráficos los perfiles (edad y sexo) de las personas que más están involucradas en accidentes de tráfico y visualizar a través de un mapa la localización de los accidentes que han causado la muerte de las víctimas. Los datos los descargamos de la págína del ayuntamiento de Barcelona de los años 2016 y 2017 e involucran dos archivos CSV: Personas involucradas y Vehículos.*

## Importación y limpieza de datos  

Importamos los archivos ccvs de personas involucradas y vemos las primeras 5 líneas.
En el caso de las coordenadas, al importarlas de forma standard se eliminaban los decimales, es por esto que tuvimos que cambiar la , por . y luego convertir el campo en numerico.  

```{r}
install.packages("readr")

library(readr)

delim = ","
dec = ","
personas2016 <- read.csv("2016_accidents_persones_gu_bcn.csv", header=TRUE, sep=delim, dec=dec, stringsAsFactors=FALSE)
class(personas2016$Coordenada_UTM_.X.)
options(digits=10)
personas2016$Coordenada_UTM_.X. <- (gsub(",", ".", as.character(personas2016$Coordenada_UTM_.X.)))
personas2016$Coordenada_UTM_.X. <- as.numeric(personas2016$Coordenada_UTM_.X.)
personas2016$Coordenada_UTM_.Y. <- (gsub(",", ".", as.character(personas2016$Coordenada_UTM_.Y.)))
personas2016$Coordenada_UTM_.Y. <- as.numeric(personas2016$Coordenada_UTM_.Y.)
head(personas2016)

personas2017<- read.csv("2017_accidents_persones_gu_bcn_.csv", header= TRUE, sep=",")
head(personas2017)
class(personas2017$Coordenada_UTM_.X.)
options(digits=10)
personas2017$Coordenada_UTM_.X.<- (gsub(",", ".", as.character(personas2017$Coordenada_UTM_.X.)))
personas2017$Coordenada_UTM_.X. <- as.numeric(personas2017$Coordenada_UTM_.X.)
personas2017$Coordenada_UTM_.Y. <- (gsub(",", ".", as.character(personas2017$Coordenada_UTM_.Y.)))
personas2017$Coordenada_UTM_.Y. <- as.numeric(personas2017$Coordenada_UTM_.Y.)
head(personas2017)
```


Estudiamos la estructura y dimensión de los dos DataFrames.  

```{r}
dim(personas2016)
dim(personas2017)
str(personas2016)
str(personas2017)
```


Juntamos en un unico DataFrame las victimas de 2016 y 2017.  

```{r}
victimas <- rbind(personas2016, personas2017)
```


Verificamos que se mantengan la estructura y dimensión original.  

```{r}
head(victimas) == head(personas2016)
tail(victimas) == tail(personas2017)
dim(victimas)[1] == dim(personas2016)[1] + dim(personas2017)[1]
(dim(victimas)[2] == dim(personas2016)[2]) & (dim(victimas)[2] == dim(personas2017)[2])
```


Creamos un DataFrame con las columnas que utilizaremos durante nuestra analisis.

```{r}
filtro_victimas <- c("Número_d.expedient", 'Nom.districte', 'Descripció_dia_setmana',
       'NK.Any', 'Mes.de.any', 'Dia.de.mes',
       'Descripció.torn', 'Descripció_sexe', 'Edat',
       'Descripció_tipus_persona', 'Descripció_victimització',
       "Coordenada_UTM_.X.", "Coordenada_UTM_.Y.")
victimas <- victimas[filtro_victimas]
head(victimas)
```


Cambiamos los nombres de las columnas.

```{r}
names(victimas) <- c('NumExpediente', 'Distrito', 'DiaSemana', 'Ano', 'Mes', 'Dia','Horario', 'Sexo', 'Edad', 'TipoPersona', 'TriajeVictima', 'C_UTM_X', 'C_UTM_Y')
head(victimas)
```


Vamos a repetir las mismas operaciones con las bases de datos de vehiculos. Para este trabajo vamos a tomar en cuenta el Modelo del vehiculo, la tipología de carnet del conductor y la antiguedad del carnet.

```{r}
vehiculos2016<- read.csv("2016_accidents_vehicles_gu_bcn_.csv")
head(vehiculos2016)
vehiculos2017<- read.csv("2017_accidents_vehicles_gu_bcn_.csv")
head(vehiculos2017)

dim(vehiculos2016)
dim(vehiculos2017)
str(vehiculos2016)
str(vehiculos2017)

filtro_vehiculos2016 <- c("Codi.d.expedient", 'Descripció.tipus.de.vehicle', 'Descripció.carnet',
       'Antiguitat.carnet')
vehiculos2016 <- vehiculos2016[filtro_vehiculos2016]
head(vehiculos2016)

filtro_vehiculos2017 <- c("Codi_expedient", 'Descripcio_tipus_de_vehicle', 'Descripcio_carnet',
       'Antiguitat_carnet')
vehiculos2017 <- vehiculos2017[filtro_vehiculos2017]
head(vehiculos2017)

names(vehiculos2016) <- c('NumExpediente', 'Modelo', 'Carnet', 'Antig_carnet')
names(vehiculos2017) <- c('NumExpediente', 'Modelo', 'Carnet', 'Antig_carnet')

vehiculos <- rbind(vehiculos2016, vehiculos2017)

head(vehiculos)

dim(vehiculos)[1] == dim(vehiculos2016)[1] + dim(vehiculos2017)[1]
(dim(vehiculos)[2] == dim(vehiculos2016)[2]) & (dim(vehiculos)[2] == dim(vehiculos2017)[2])
```


Ahora limpiamos los datos.


Vamos a estudiar los Modelos de vehículos para revisar que no existan errores de tipeo o que un mismo Modelo este escrito de maneras distintas.

```{r}
class(vehiculos$Modelo)
```


Como está en factor lo tengo que convertir en character.

```{r}
vehiculos$Modelo<-as.character(vehiculos$Modelo)
```


Quiero saber todos los nombres distintos que aparecen en el campo "Modelo".

```{r}
unique(vehiculos$Modelo)
```


Aquí podemos observar que hay variables que se repiten porque están escritas de maneras distintas como por ejemplo Cuadriciclo >=75cc = Quadricicle > 75 cc y Turisme = Turismo Por lo que debo normalizar la información.

```{r}
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Carro", "Turismo", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Turisme", "Turismo", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Quadricicle > 75 cc", "Cuadriciclo >=75cc", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Tot terreny", "Todo terreno", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Quadricicle < 75 cc", "Cuadriciclo <75cc", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Tractor camió", "Tractocamión", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Microbus <= 17", "Microbus <=17 plazas", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Altres vehicles amb motor", "Otros vehíc. a motor", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Maquinària d'obres i serveis", "Maquinaria de obras", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Camió rígid <= 3,5 tones", "Camión <= 3,5 Tm", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Camió rígid > 3,5 tones", "Camión > 3,5 Tm", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Tren o tramvia", "Tranvía o tren", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Autobús articulat", "Autobús articulado", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "Autocar", "Autobús", vehiculos$Modelo)
vehiculos$Modelo<-ifelse(vehiculos$Modelo == "", "Desconegut", vehiculos$Modelo)
```


Comprobamos.

```{r}
unique(vehiculos$Modelo)
```


Ahora revisamos los tipos de carnet.

```{r}
class(vehiculos$Carnet)
```


Como está en factor, lo debo convertir en character.

```{r}
vehiculos$Carnet<-as.character(vehiculos$Carnet)
```


Quiero saber todos los nombres distintos que aparecen en el campo "Carnet".

```{r}
unique(vehiculos$Carnet)
```


Los tipos de carnet de conducir que existen en España son: AM, A1, A2, A, B1, B, C1, C, D1, D, BE, C1E, CE, D1E, DE y BTP (ya está descontinuado). Además que hay personas que conducen sin permiso o son las victimas. 
Tomamos como Licencia a aquellas personas que conducen con permisos extranjeros y esta variable tiene un error de tipeo. También "Desconegut" = "Es desconeix".
Normalizamos esta información.

```{r}
vehiculos$Carnet<-ifelse(vehiculos$Carnet == "E C", "CE", vehiculos$Carnet)
vehiculos$Carnet<-ifelse(vehiculos$Carnet == "Es desconeix", "Desconegut", vehiculos$Carnet)
vehiculos$Carnet<-ifelse(vehiculos$Carnet == "Llicència", "licencia", vehiculos$Carnet)
vehiculos$Carnet<-ifelse(vehiculos$Carnet == "E D", "DE", vehiculos$Carnet)
vehiculos$Carnet<-ifelse(vehiculos$Carnet == "E C1", "C1E", vehiculos$Carnet)
vehiculos$Carnet<-ifelse(vehiculos$Carnet == "E B", "BE", vehiculos$Carnet)
vehiculos$Carnet<-ifelse(vehiculos$Carnet == "E D1", "D1E", vehiculos$Carnet)
vehiculos$Carnet<-ifelse(vehiculos$Carnet == "", "Desconegut", vehiculos$Carnet)
```


Comprobamos.

```{r}
unique(vehiculos$Carnet)
```


Realizamos el mismo proceso para verificar la antiguedad de los carnets.
Como la antiguedad del carnet no puede ser negativa ni mayor a 100, decimos que es un error a la hora de tomar los datos y lo agrupamos en desconocidos. Pero primero es necesario convertirlo en numerico.

```{r}
class(vehiculos$Antig_carnet)
vehiculos$Antig_carnet<-as.numeric(as.character(vehiculos$Antig_carnet))
unique(vehiculos$Antig_carnet)
```


Limpiamos los datos.

```{r}
vehiculos$Antig_carnet<-ifelse(vehiculos$Antig_carnet == 0, 0, vehiculos$Antig_carnet)
vehiculos$Antig_carnet<-ifelse(vehiculos$Antig_carnet < 0, NA, vehiculos$Antig_carnet)
vehiculos$Antig_carnet<-ifelse(vehiculos$Antig_carnet > 100, NA, vehiculos$Antig_carnet)
```


Comprobamos.

```{r}
unique(vehiculos$Antig_carnet)
```


Procedemos a revisar los distritos y a transformarlos en character.

```{r}
victimas$Distrito<-as.character(victimas$Distrito)
```

```{r}
unique(victimas$Distrito)
```

En el caso de los distritos no hay nada que modificar.


Revisamos los días de semana.

```{r}
class(victimas$DiaSemana)
unique(victimas$DiaSemana)
```

Tampoco hay nada que transformar en esta columna. 


Revisamos que solamente tengamos como año 2016 y 2017 y verificamos que sea numerico.

```{r}
unique(victimas$Ano)
class(victimas$Ano)
```


Revisamos que el campo de día de semana tenga sólo valores de 1 a 31 y verificamos que efectivamente sea numerico.

```{r}
unique(victimas$Dia)
class(victimas$Dia)
```


Ahora revisamos que el campo de mes tenga sólo valores de 1 a 12 y que sea numerico.

```{r}
unique(victimas$Mes)
class(victimas$Mes)
```


Procedemos a revisar el horario, que se refiere a si ocurrió en la mañana, tarde o noche.

```{r}
unique(victimas$Horario)
```


Revisamos el sexo para verificar que no haya ningun error de tipeo.

```{r}
unique(victimas$Sexo)
```


Comprobamos el tipo las edades de las victimas.

```{r}
class(victimas$Edad)
```


Hay que transformarlo en numerico.

```{r}
victimas$Edad<-as.integer(victimas$Edad)
```


Vemos las edades de las personas involucradas.

```{r}
unique(victimas$Edad)
```


Tomamos como error las edades mayores a 112 años (que es la persona más vieja de España) y las agrupamos en los desconocidos.

```{r}
victimas$Edad= ifelse(victimas$Edad > 112, NA, victimas$Edad)
```


Comprobamos.

```{r}
unique(victimas$Edad)
```


Revisamos el tipo de persona que se refiere al papel de la victima, es decir, si era el conductor, el pasajero, peaton, etc.

```{r}
unique(victimas$TipoPersona)
```


El triaje se refiere a la gravedad del herido.

```{r}
unique(victimas$TriajeVictima)
```


Para el analisis agrupamos en leve, grave y muerto.

```{r}
victimas$TriajeVictima<-ifelse(victimas$TriajeVictima == "Ferit lleu: Hospitalització fins a 24h", "Ferit lleu", victimas$TriajeVictima)
victimas$TriajeVictima<-ifelse(victimas$TriajeVictima == "Ferit lleu: Amb assistència sanitària en lloc d'accident", "Ferit lleu", victimas$TriajeVictima)
victimas$TriajeVictima<-ifelse(victimas$TriajeVictima == "Ferit lleu: Rebutja assistència sanitària", "Ferit lleu", victimas$TriajeVictima)
victimas$TriajeVictima<-ifelse(victimas$TriajeVictima == "Ferit greu: hospitalització superior a 24h", "Ferit greu", victimas$TriajeVictima)
victimas$TriajeVictima<-ifelse(victimas$TriajeVictima == "Mort (dins 24h posteriors accident)", "Mort", victimas$TriajeVictima)
```


Comprobamos.

```{r}
unique(victimas$TriajeVictima)
```

Ya tenemos los datos limpios por lo que procedemos a interpretarlos.  


## Graficos


Primero instalamos ggplot2 y llamamos a la libreria.

```{r}
install.packages("ggplot2")
library(ggplot2)
```


Ahora graficamos un histograma con la cantidad de victimas según la edad utilizando en el eje x la escala de 5 años.

```{r}
ggplot(data=victimas, aes(victimas$Edad)) + 
  geom_histogram(breaks=seq(0, 100, by = 5), 
                 col="red", 
                 aes(fill=..count..)) +
  scale_fill_gradient("Número victimas", low = "green", high = "red") +
labs(title="Histograma número de victimas por edad") +
labs(x="Edad", y="Cantidad")
```

En este histograma podemos ver una representación gráfica de la cantidad de victimas según la edad. El histograma incluye a su vez un mapa de calor que permite una visualización más rápida. Se puede observar que la mayoria de las victimas se concentran en la edad de 20 a 30 años.

Ahora veremos las estadísticas principales de la edad:

```{r}
summary(victimas$Edad)
```
La edad mínima de las victimas es de 0, lo que puede implicar que hay niños menores a 1 año involucrados y la edad promedio es de 38 años.

A continuación realizamos un histograma de la cantidad de accidentes según la antiguedad del carnet. Para ello se utiliza en el eje x la escala de 5 años

```{r}
ggplot(data=vehiculos, aes(vehiculos$Antig_carnet)) + 
  geom_histogram(breaks=seq(0, 70, by = 5), 
                 col="blue", 
                 aes(fill=..count..)) +
  scale_fill_gradient("Número victimas", low = "green", high = "darkblue") +
labs(title="Histograma número de victimas por antiguedad de carnet") +
labs(x="Antiguedad", y="Cantidad")
```

En este histograma podemos observar como disminuye el número de accidentes al crecer de la antiguedad del carnet de conducir.

Vemos las estadisticas principales de la antiguedad de carnet.

```{r}
summary(vehiculos$Antig_carnet)
```


Ahora instalamos el paquete de Tidyverse para poder utilizar la libreria de dplyr que nos permite analizar y manipular datos en un DataFrame

```{r}
install.packages("tidyverse")
library(dplyr)
```


Agrupamos por día de semana y graficamos para ver la tendencia.

```{r}
PorDia<- victimas %>%
    group_by(DiaSemana) %>%
    summarize(Total=n())%>%
    arrange(desc(Total))
PorDia
```


```{r}
positions<- c("Dilluns", "Dimarts", "Dimecres", "Dijous", "Divendres", "Dissabte", "Diumenge" )

ggplot(data.frame(victimas), aes(x=victimas$DiaSemana)) +
  scale_x_discrete(limits= positions, labels=c("Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado", "Domingo"))+
  geom_bar()+
labs(title="Histograma número de victimas por día de la semana") +
labs(x="Dias de semana", y="Cantidad")

```

Con el gráfico anterior podemos observar que los accidentes tienen una tendencia creciente los días de semana, teniendo un pico los días viernes y que estos disminuyen considerablemente los fines de semana, en especial el domingo. 


Ahora vamos a graficar los horarios. 

```{r}
pos<- c("Matí", "Tarda", "Nit")

ggplot(data.frame(victimas), aes(x=victimas$Horario)) +
  scale_x_discrete(limits= pos, labels=c("Mañana", "Tarde", "Noche"))+
  geom_bar()+
labs(title="Histograma número de victimas por horario") +
labs(x="Horario", y="Cantidad")
```

Podemos observar que la mayoría de los accidentes ocurren por la tarde. 


Agrupamos los tipos de carnet y por vehiculos.

```{r}
TipoCarnet<- vehiculos %>%
    group_by(Carnet) %>%
    summarize(Total=n())%>%
    arrange(desc(Total))
TipoCarnet
```


```{r}
TipoVehiculo<- vehiculos %>%
    group_by(Modelo) %>%
    summarize(Total=n())%>%
    arrange(desc(Total))
TipoVehiculo
```


Graficamos para ver la cantidad de accidentes por barrio.

```{r}
ggplot(data.frame(victimas), aes(x=victimas$Distrito)) +
  geom_bar(col= "blue" ,fill="blue")+
labs(title="Histograma número de victimas por distrito") +
labs(x="Distrito", y="Cantidad")
```
El distrito con mayor cantidad de accidentes es el Eixample o en castellano, el Ensanche, que es el tiene mayor cantidad de accidentes. Cabe destacar que es el distrito más poblado de Barcelona en terminos relativos y absolutos.

Creamos una tabla para ver la cantidad de accidentes según el día de semana y el horario y lo graficamos en un mapa de calor.

```{r}
nueva<-victimas %>%
  group_by(DiaSemana, Horario) %>%
  summarize(Total=n())
```

```{r}

positions<- c("Dilluns", "Dimarts", "Dimecres", "Dijous", "Divendres", "Dissabte", "Diumenge")

nueva$Horario <- factor(nueva$Horario, levels = c("Matí", "Tarda", "Nit"), labels=c("Mañana", "Tarde", "Noche"))

ggplot(nueva, aes(x = nueva$DiaSemana, y = nueva$Horario, fill = nueva$Total)) + scale_x_discrete(limits= positions, labels=c("Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado", "Domingo")) + geom_tile() +
  scale_fill_gradient(low = "white", high = "steelblue")+
  labs(x = "Día Semana", y = "Horario", fill = "Número Accidentes", title = "Mapa de calor número de victimas por día de la semana y horario")
```
Este gráfico nos permite observar que los días con más accidentes son los viernes por la tarde. 

## Mapas


*Nota: para diseñar un punto en un mapa con la libreria cartociudad, hace falta conocer su latitud y longitud. Por este trabajo, decidimos utilizar sólo las bases de datos de 2016 y 2017, que ya contienen los datos de latitud y longitud a parte de las coordenadas UTM, entonces este procedimiento resulta redondante. Decidimos seguir este camino porque las bases de datos de los años anteriores sólo contienen las coordenadas UTM y entonces nos pareció interesante encontrar una solución a este problema.*


Creamos un nuevo DataFrame eliminando del DataFrame original las filas con coordenadas nulas o <0.

```{r}
victimas_sin_coord_nulas <- victimas[(!is.na(victimas$C_UTM_X) & !is.na(victimas$C_UTM_Y) & victimas$C_UTM_X>0 & victimas$C_UTM_Y>0), ]
victimas_sin_coord_nulas[(is.na(victimas_sin_coord_nulas$C_UTM_X) | is.na(victimas_sin_coord_nulas$C_UTM_Y) | victimas_sin_coord_nulas$C_UTM_X<0 | victimas_sin_coord_nulas$C_UTM_Y<0), ]
head(victimas_sin_coord_nulas)
```


Instalamos los paquetes necesarios y trasformamos las coordenadas UTM en latitud y longitud.

```{r}

install.packages("sp")
library(sp)  # vector data
install.packages("raster")
library(raster)  # raster data
install.packages("rgdal")
library(rgdal)  # input/output, projections
install.packages("rgeos")
library(rgeos)  # geometry ops

utmcoor<-SpatialPoints(victimas_sin_coord_nulas[, c("C_UTM_X", "C_UTM_Y")], proj4string=CRS("+proj=utm +zone=31"))
longlatcoor<-spTransform(utmcoor,CRS("+proj=longlat"))
head(longlatcoor)
```


Añadimos los campos de latitud y longitud al DataFrame. Nos damos cuenta que hay un error en los valores de las coordenadas UTM que genera un deslizamiento de los puntos en el mapa. Afortunadamente, para arreglar este error es suficiente restar a latitud y longitud unos valores fijos.

```{r}
victimas_sin_coord_nulas$Long <- longlatcoor$C_UTM_X-0.001103145
victimas_sin_coord_nulas$Lat <- longlatcoor$C_UTM_Y-0.00184649
head(victimas_sin_coord_nulas)
```


Diseñamos en el mapa todos los puntos donde se haya tenido victimas de accidentes durante los años 2016 y 2017.

```{r}
install.packages("devtools")
library(devtools)
install_github("rOpenSpain/caRtociudad")
library(caRtociudad)
install.packages("ggmap")
library(ggmap)

bcn <- cartociudad_geocode("barcelona")
mapa_bcn <- cartociudad_get_map(c(bcn$lat, bcn$lng), 2)
mapa <- ggmap::ggmap(mapa_bcn)
mapa + geom_point(aes(x = Long, y = Lat), data = victimas_sin_coord_nulas, size = 1)
```

