---
title: "Random Forest"
author: "ASO"
date: "10/5/2019"
output:
  html_document: default
  pdf_document: default
---

Se crea conexi贸n con la bbdd postgres
```{r}
#install.packages("RPostgreSQL")
require("RPostgreSQL")

# Guardar el Password para poder posteriormente eliminarlo
pw <- { "1701"}

# Leer el driver de PostgreSQL
drv <- dbDriver("PostgreSQL")

# Crear la conexion con la base de datos
con <- dbConnect(drv, dbname = "postgres",
                 host = "localhost", port = 5432,
                 user = "postgres", password = pw)
# Eliminar el Password
rm(pw) 

# Chequear que existe la tabla de la base de datos para comprobar la conexi贸n
dbExistsTable(con, "descripcion_carnet")

```

Importaci贸n paquetes m谩s gen茅ricos
```{r}
library(readr)
library(ISLR)
library(ggplot2)
library(caret)
library(dplyr)
library(magrittr)
library(tidyverse)
library(rpart)
library(randomForest)
library(rpart.plot)
```

Importaci贸n data de vehculos
```{r}
vehiculo <- dbGetQuery(con, "SELECT * FROM vehiculo_involucrado")
head(vehiculo)
```

Importaci贸n tablas relacionadas con vehculos 
```{r}
tipologia <-dbGetQuery(con, "SELECT * FROM descripcion_tipologia_vehiculo")
head(tipologia)
```

```{r}
marca <-dbGetQuery(con, "SELECT * FROM descripcion_marca_vehiculo")
head(marca)
```

```{r}
color <-dbGetQuery(con, "SELECT * FROM descripcion_color_vehiculo")
head(color)
```

```{r}
carnet <-dbGetQuery(con, "SELECT * FROM descripcion_carnet")
head(carnet)
```



Combinaci贸n de las tablas

```{r}
datos1 <- merge(x = vehiculo, y = tipologia, by = "id_desc_tipologia", all = TRUE)
names(datos1)
```

```{r}
datos2 <- merge(x = datos1, y = marca, by = "id_desc_marca", all = TRUE)
names(datos2)
```

```{r}
datos3 <- merge(x = datos2, y = carnet, by = "id_desc_carnet", all = TRUE)
names(datos3)
```

```{r}
datos4 <- merge(x = datos3, y = color , by = "id_desc_color", all = TRUE)
names(datos4)
```

Comprobaci贸n

```{r}
head(datos4)
```

Revisi贸n de filas y columnas totales
```{r}

dim(datos4)
```

Selecci贸n de columnas con las que se trabajar谩

```{r}
datos5<- datos4[,c("antiguedad_carnet", "desc_tipologia", "desc_marca", "desc_color", "desc_carnet")]
head(datos5)
```


Agrupaci贸n por vehiculos
```{r}
datos6 <- datos5 %>%
  group_by(antiguedad_carnet, desc_tipologia, desc_marca, desc_color, desc_carnet) %>%
  summarise(cantvehiculos=n())
datos6
```


Partici贸n del dataset en 2 grupos: entrenamiento y validaci贸n 
```{r}
set.seed(12)
n = nrow(datos6) 
n
frac_train <- .70
mascara <- sample(c(rep("train", 3343), rep("test", n -3343)), n)
entrevali <- split(datos6, mascara)
entrevali$train
```

Modelo Random Forest (Relacion cantidad vehiculos vs. antiguedad carnet)
```{r}
model.rf <- randomForest(formula = cantvehiculos ~ antiguedad_carnet, importance = TRUE ,data = entrevali$train)
varImpPlot(model.rf)
plot(model.rf$predicted)
```

```{r}
preds <- predict(model.rf,data = entrevali$train)
real <- entrevali$train$cantvehiculos
plot(real, preds)

summary 
```

```{r}
RMSE <- sqrt(mean((real - preds)^2))
RMSE
```

Modelo Random Forest (Relacion cantidad vehiculos vs. tipologia de vehiculo)

```{r}
datos7 <- datos4 %>%
  group_by(antiguedad_carnet, id_desc_tipologia, id_desc_marca, id_desc_color, id_desc_carnet) %>%
  summarise(cantvehiculos=n())
datos7
```
Partici贸n del dataset en 2 grupos: entrenamiento y validaci贸n 
```{r}
set.seed(12)
n = nrow(datos6) 
n
frac_train <- .70
mascara <- sample(c(rep("train", 3343), rep("test", n -3343)), n)
entrevali <- split(datos7, mascara)
entrevali$train
```

```{r}
model.rf <- randomForest(formula = cantvehiculos ~ id_desc_tipologia, importance = TRUE ,data = entrevali$train)
varImpPlot(model.rf)
plot(model.rf$predicted)
```



```{r}
preds <- predict(model.rf,data = entrevali$train)
real <- entrevali$train$cantvehiculos
plot(real, preds)

summary 
```


```{r}
RMSE <- sqrt(mean((real - preds)^2))
RMSE
```



Modelo Random Forest (Relacion cantidad vehiculos vs. desc_carnet)
```{r}
model.rf <- randomForest(formula = cantvehiculos ~ id_desc_carnet, importance = TRUE ,data = entrevali$train)
varImpPlot(model.rf)
plot(model.rf$predicted)
```



```{r}
preds <- predict(model.rf,data = entrevali$train)
real <- entrevali$train$cantvehiculos
plot(real, preds)

summary 
```


```{r}
RMSE <- sqrt(mean((real - preds)^2))
RMSE
```
